from aiogram import types, Dispatcher
from aiogram.dispatcher.filters.state import State, StatesGroup
from aiogram.dispatcher import FSMContext
from aiogram.utils.exceptions import Throttled

import gc

from bot import bot, db, dp
from keybroads.client import (
    select_language_kb, switch_generate_photo_ru_kb, switch_generate_photo_uz_kb, comeback_ru_kb, comeback_uz_kb
)

from utils.scripts.generate_params import output_params
from utils.scripts.create_files import create_image, create_video

import os


class Generate(StatesGroup):
    generate_file = State()
    generate_photo = State()
    generate_video = State()


async def command_start(message: types.Message):
    user_id = message.from_user.id
    try:
        await dp.throttle('start', rate=3)
    except Throttled:
        await bot.send_message(user_id, '–ù–µ —Ñ–ª—É–¥–∏—Ç–µ!')
    else:
        if await db.check_user(user_id):
            await bot.send_message(user_id,
                                   "‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
                                   "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, —è –±–æ—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤. –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫. üá∑üá∫\n"
                                   "‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
                                   "Asslomu alaykum, men promokodlarni yaratadigan bot. Tilni tanlang. üá∫üáø",
                                   reply_markup=select_language_kb)
        else:
            await db.add_user(user_id, message.from_user.first_name, message.from_user.username, 'ru')
            await bot.send_message(user_id,
                                   "‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
                                   "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, —è –±–æ—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤. –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫. üá∑üá∫\n"
                                   "‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
                                   "Asslomu alaykum, men promokodlarni yaratadigan bot. Tilni tanlang. üá∫üáø",
                                   reply_markup=select_language_kb)


async def choose_language(message: types.Message):
    await bot.send_message(message.from_user.id,
                           "‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
                           "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, —è –±–æ—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤. –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫. üá∑üá∫\n"
                           "‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
                           "Asslomu alaykum, men promokodlarni yaratadigan bot. Tilni tanlang. üá∫üáø",
                           reply_markup=select_language_kb)


async def switch_language_to_ru_or_uz(message: types.Message):
    user_id = message.from_user.id
    print(message.text)
    if message.text == '–†—É—Å—Å–∫–∏–π üá∑üá∫':
        language = 'ru'
        await bot.send_message(user_id,
                               "‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
                               "–í—ã–±—Ä–∞–Ω —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫. üá∑üá∫\n"
                               "‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
                               "–í—ã–±–µ—Ä–∏—Ç–µ —á–µ—Ä–µ–∑ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤ –∫–∞–∫–æ–º –≤–∏–¥–µ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ ‚¨áÔ∏è",
                               reply_markup=switch_generate_photo_ru_kb)
    else:
        language = 'uz'
        await bot.send_message(user_id,
                               "‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
                               "O ªzbek tili tanlangan. üá∫üáø\n"
                               "‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
                               "Promo-kodni qaysi shaklda olishni xohlayotganingizni klaviatura orqali tanlang ‚¨áÔ∏è",
                               reply_markup=switch_generate_photo_uz_kb)
    await db.switch_language(user_id, language)


async def generate_photo_as_file(message: types.Message):
    user_id = message.from_user.id
    check_language = await db.check_language(user_id)
    if check_language == 'ru':
        await bot.send_message(message.from_user.id,
                               "‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
                               "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç 1 –¥–æ 13 —Å–∏–º–≤–æ–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç–∏—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ –ø—Ä–æ–º–æ–∫–æ–¥–µ. ‚¨áÔ∏è\n",
                               reply_markup=comeback_ru_kb)
    else:
        await bot.send_message(message.from_user.id,
                               "‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
                               "Promo-kodda yaratmoqchi bo'lgan 1 dan 13 gacha harflar yoki "
                               "raqamlardan iborat so'zni kiriting.. ‚¨áÔ∏è\n",
                               reply_markup=comeback_uz_kb)
    await Generate.generate_file.set()


async def generate_video(message: types.Message):
    user_id = message.from_user.id
    check_language = await db.check_language(user_id)
    if check_language == 'ru':
        await bot.send_message(message.from_user.id,
                               "‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
                               "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç 1 –¥–æ 13 —Å–∏–º–≤–æ–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç–∏—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ –ø—Ä–æ–º–æ–∫–æ–¥–µ. ‚¨áÔ∏è\n",
                               reply_markup=comeback_ru_kb)
    else:
        await bot.send_message(message.from_user.id,
                               "‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
                               "Promo-kodda yaratmoqchi bo'lgan 1 dan 13 gacha harflar yoki "
                               "raqamlardan iborat so'zni kiriting.. ‚¨áÔ∏è\n",
                               reply_markup=comeback_uz_kb)
    await Generate.generate_video.set()


async def generate_photo_as_photo(message: types.Message):
    user_id = message.from_user.id
    check_language = await db.check_language(user_id)
    if check_language == 'ru':
        await bot.send_message(message.from_user.id,
                               "‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
                               "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç 1 –¥–æ 13 —Å–∏–º–≤–æ–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç–∏—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ –ø—Ä–æ–º–æ–∫–æ–¥–µ. ‚¨áÔ∏è\n",
                               reply_markup=comeback_ru_kb)
    else:
        await bot.send_message(message.from_user.id,
                               "‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
                               "Promo-kodda yaratmoqchi bo'lgan 1 dan 13 gacha harflar yoki "
                               "raqamlardan iborat so'zni kiriting.. ‚¨áÔ∏è\n",
                               reply_markup=comeback_uz_kb)
    await Generate.generate_photo.set()


async def send_generate_photo(message: types.Message, state: FSMContext):
    text = message.text
    user_id = message.from_user.id
    if text == '–ù–∞–∑–∞–¥':
        await state.finish()
        await bot.send_message(user_id,
                               "‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
                               "–í—ã–±–µ—Ä–∏—Ç–µ —á–µ—Ä–µ–∑ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤ –∫–∞–∫–æ–º –≤–∏–¥–µ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ ‚¨áÔ∏è",
                               reply_markup=switch_generate_photo_ru_kb)
    elif text == 'Orqaga':
        await state.finish()
        await bot.send_message(user_id,
                               "‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
                               "Promo-kodni qaysi shaklda olishni xohlayotganingizni klaviatura orqali tanlang ‚¨áÔ∏è",
                               reply_markup=switch_generate_photo_uz_kb)
    else:
        try:
            await dp.throttle('throttling_file', rate=150)
        except Throttled:
            await bot.send_message(user_id, '–î–æ–∂–¥–∏—Ç–µ—Å—å –æ–∫–Ω–æ–Ω—á–∞–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∞—à–∏—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤!')
        else:
            check_language = await db.check_language(user_id)
            if check_language == 'ru':
                if len(text) >= 14:
                    await bot.send_message(user_id, '‚ùå –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –¥–æ–ø—É—Å—Ç–∏–º—ã–π –≤–≤–æ–¥ —Å–∏–º–≤–æ–ª–æ–≤ 13!')
                else:
                    await state.finish()
                    get_params = output_params(text)
                    get_amount_files = os.listdir(
                        os.path.join(
                            os.path.dirname(os.path.realpath('main.py')), 'data', 'images', 'compressed', 'ru')
                    )
                    number = 0
                    message_progress = await bot.send_message(user_id, f'‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ'
                                                                       f'\n‚ùï–ù–∞—á–∞–ª–∞—Å—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤!'
                                                                       f'\n‚ôªÔ∏è–ü—Ä–æ–≥—Ä–µ—Å—Å {number}/{len(get_amount_files)}')
                    for file in get_amount_files:
                        file_path = os.path.join(os.path.dirname(
                            os.path.realpath('main.py')), 'data', 'images', 'compressed', 'ru', file
                        )
                        create_img = create_image(file_path, get_params['coordinate'], get_params['font_size'], text,
                                                  number, 32)
                        number += 1
                        await bot.edit_message_text(f'‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ'
                                                    f'\n‚ùï–ù–∞—á–∞–ª–∞—Å—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤!'
                                                    f'\n‚ôªÔ∏è–ü—Ä–æ–≥—Ä–µ—Å—Å {number}/{len(get_amount_files)}', user_id,
                                                    message_progress.message_id)
                        await message.reply_photo(open(create_img, 'rb'))
                        os.remove(create_img)
                        gc.collect()

                    await bot.send_message(user_id, '‚ôª –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!',
                                           reply_markup=switch_generate_photo_ru_kb)
            elif check_language == 'uz':
                if len(text) >= 14:
                    await bot.send_message(user_id, '‚ùå Maksimal ruxsat etilgan belgilar kiritish - 13!')
                else:
                    get_params = output_params(text)
                    get_amount_files = os.listdir(
                        os.path.join(
                            os.path.dirname(os.path.realpath('main.py')), 'data', 'images', 'not_compressed', 'uz')
                    )
                    number = 0
                    message_progress = await bot.send_message(user_id, f'‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ'
                                                                       f'\n‚ùïPromokodlar yaratish boshlandi!'
                                                                       f'\n‚ôªÔ∏èTaraqqiyot {number}/{len(get_amount_files)}')
                    for file in get_amount_files:
                        file_path = os.path.join(os.path.dirname(
                            os.path.realpath('main.py')), 'data', 'images', 'not_compressed', 'uz', file
                        )
                        create_img = create_image(file_path, get_params['coordinate'], get_params['font_size'], text,
                                                  number, 32)
                        number += 1
                        await bot.edit_message_text(f'‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ'
                                                    f'\n‚ùïPromokodlar yaratish boshlandi!'
                                                    f'\n‚ôªÔ∏èTaraqqiyot {number}/{len(get_amount_files)}', user_id,
                                                    message_progress.message_id)
                        await message.reply_photo(open(create_img, 'rb'))
                        os.remove(create_img)
                        gc.collect()
                    await state.finish()
                    await bot.send_message(user_id, '‚ôª –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!',
                                           reply_markup=switch_generate_photo_uz_kb)


async def send_generate_file(message: types.Message, state: FSMContext):
    text = message.text
    user_id = message.from_user.id
    if text == '–ù–∞–∑–∞–¥':
        await state.finish()
        await bot.send_message(user_id,
                               "‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
                               "–í—ã–±–µ—Ä–∏—Ç–µ —á–µ—Ä–µ–∑ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤ –∫–∞–∫–æ–º –≤–∏–¥–µ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ ‚¨áÔ∏è",
                               reply_markup=switch_generate_photo_ru_kb)
    elif text == 'Orqaga':
        await state.finish()
        await bot.send_message(user_id,
                               "‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
                               "Promo-kodni qaysi shaklda olishni xohlayotganingizni klaviatura orqali tanlang ‚¨áÔ∏è",
                               reply_markup=switch_generate_photo_uz_kb)
    else:
        try:
            await dp.throttle('throttling_file', rate=150)
        except Throttled:
            await bot.send_message(user_id, '–î–æ–∂–¥–∏—Ç–µ—Å—å –æ–∫–Ω–æ–Ω—á–∞–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∞—à–∏—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤!')
        else:
            check_language = await db.check_language(user_id)
            if check_language == 'ru':
                if len(text) >= 14:
                    await bot.send_message(user_id, '‚ùå –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –¥–æ–ø—É—Å—Ç–∏–º—ã–π –≤–≤–æ–¥ —Å–∏–º–≤–æ–ª–æ–≤ 13!')
                else:
                    await state.finish()
                    get_params = output_params(text)
                    get_amount_files = os.listdir(
                        os.path.join(
                            os.path.dirname(os.path.realpath('main.py')), 'data', 'images', 'not_compressed', 'ru')
                    )
                    number = 0
                    message_progress = await bot.send_message(user_id, f'‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ'
                                                                       f'\n‚ùï–ù–∞—á–∞–ª–∞—Å—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤!'
                                                                       f'\n‚ôªÔ∏è–ü—Ä–æ–≥—Ä–µ—Å—Å {number}/{len(get_amount_files)}')
                    for file in get_amount_files:
                        file_path = os.path.join(os.path.dirname(
                            os.path.realpath('main.py')), 'data', 'images', 'not_compressed', 'ru', file
                        )
                        create_img = create_image(file_path, get_params['coordinate'], get_params['font_size'], text,
                                                  number, 'black')
                        number += 1
                        await bot.edit_message_text(f'‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ'
                                                    f'\n‚ùï–ù–∞—á–∞–ª–∞—Å—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤!'
                                                    f'\n‚ôªÔ∏è–ü—Ä–æ–≥—Ä–µ—Å—Å {number}/{len(get_amount_files)}', user_id,
                                                    message_progress.message_id)
                        await message.reply_document(open(create_img, 'rb'))
                        os.remove(create_img)
                        gc.collect()

                    await bot.send_message(user_id, '‚ôª –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!',
                                           reply_markup=switch_generate_photo_ru_kb)
            elif check_language == 'uz':
                if len(text) >= 14:
                    await bot.send_message(user_id, '‚ùå Maksimal ruxsat etilgan belgilar kiritish - 13!')
                else:
                    get_params = output_params(text)
                    get_amount_files = os.listdir(
                        os.path.join(
                            os.path.dirname(os.path.realpath('main.py')), 'data', 'images', 'not_compressed', 'uz')
                    )
                    number = 0
                    message_progress = await bot.send_message(user_id, f'‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ'
                                                                       f'\n‚ùïPromokodlar yaratish boshlandi!'
                                                                       f'\n‚ôªÔ∏èTaraqqiyot {number}/{len(get_amount_files)}')
                    for file in get_amount_files:
                        file_path = os.path.join(os.path.dirname(
                            os.path.realpath('main.py')), 'data', 'images', 'not_compressed', 'uz', file
                        )
                        create_img = create_image(file_path, get_params['coordinate'], get_params['font_size'], text,
                                                  number, 'black')
                        number += 1
                        await bot.edit_message_text(f'‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ'
                                                    f'\n‚ùïPromokodlar yaratish boshlandi!'
                                                    f'\n‚ôªÔ∏èTaraqqiyot {number}/{len(get_amount_files)}', user_id,
                                                    message_progress.message_id)
                        await message.reply_document(open(create_img, 'rb'))
                        os.remove(create_img)
                        gc.collect()
                    await state.finish()
                    await bot.send_message(user_id, '‚ôª –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!',
                                           reply_markup=switch_generate_photo_uz_kb)


async def send_generate_video(message: types.Message, state: FSMContext):
    text = message.text
    user_id = message.from_user.id
    if text == '–ù–∞–∑–∞–¥':
        await state.finish()
        await bot.send_message(user_id,
                               "‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
                               "–í—ã–±–µ—Ä–∏—Ç–µ —á–µ—Ä–µ–∑ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤ –∫–∞–∫–æ–º –≤–∏–¥–µ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ ‚¨áÔ∏è",
                               reply_markup=switch_generate_photo_ru_kb)
    elif text == 'Orqaga':
        await state.finish()
        await bot.send_message(user_id,
                               "‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
                               "Promo-kodni qaysi shaklda olishni xohlayotganingizni klaviatura orqali tanlang ‚¨áÔ∏è",
                               reply_markup=switch_generate_photo_uz_kb)
    else:
        try:
            await dp.throttle('throttling_file', rate=150)
        except Throttled:
            await bot.send_message(user_id, '–î–æ–∂–¥–∏—Ç–µ—Å—å –æ–∫–Ω–æ–Ω—á–∞–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∞—à–∏—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤!')
        else:
            check_language = await db.check_language(user_id)
            if check_language == 'ru':
                if len(text) >= 14:
                    await bot.send_message(user_id, '‚ùå –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –¥–æ–ø—É—Å—Ç–∏–º—ã–π –≤–≤–æ–¥ —Å–∏–º–≤–æ–ª–æ–≤ 13!')
                else:
                    video_path = os.path.join(
                        os.path.dirname(os.path.realpath('main.py')), 'data', 'videos', 'compru.mp4'
                    )
                    video_name = create_video(video_path, text, [0, 4, 4, 6, 6, 29], 950, 2)
                    await message.reply_document(open(video_name + '.mp4', 'rb'))
                    os.remove(video_name + '.mp4')
                    gc.collect()
            elif check_language == 'uz':
                if len(text) >= 14:
                    await bot.send_message(user_id, '‚ùå Maksimal ruxsat etilgan belgilar kiritish - 13!')
                else:
                    video_path = os.path.join(
                        os.path.dirname(os.path.realpath('main.py')), 'data', 'videos', 'comp.mp4'
                    )
                    video_name = create_video(video_path, text, [0, 10, 10, 14, 14, 29], 990, 4)
                    await message.reply_document(open(video_name + '.mp4', 'rb'))
                    os.remove(video_name + '.mp4')
                    gc.collect()


def register_handlers_client(dispatcher: Dispatcher):
    dispatcher.register_message_handler(command_start, commands=['start'])

    dispatcher.register_message_handler(choose_language,
                                        content_types=['text'], text=['Tilni tanlang üá∫üáø üá∑üá∫', '–í—ã–±—Ä–∞—Ç—å —è–∑—ã–∫ üá∑üá∫ üá∫üáø'])

    dispatcher.register_message_handler(switch_language_to_ru_or_uz, content_types=['text'], text=['–†—É—Å—Å–∫–∏–π üá∑üá∫', "O'zbek tili üá∫üáø"])

    dispatcher.register_message_handler(generate_photo_as_file, content_types=['text'],
                                        text=['–ü–æ–ª—É—á–∏—Ç—å –≤ –≤–∏–¥–µ —Ñ–∞–π–ª–∞ üìÑ', 'Fayl sifatida olish üìÑ'])

    dispatcher.register_message_handler(generate_photo_as_photo, content_types=['text'],
                                        text=['–ü–æ–ª—É—á–∏—Ç—å –≤ –≤–∏–¥–µ —Ñ–æ—Ç–æ üñº', 'Foto sifatida olish üñº'])

    dispatcher.register_message_handler(generate_video, content_types=['text'],
                                        text=['–ü–æ–ª—É—á–∏—Ç—å –≤ –≤–∏–¥–µ —Ä–æ–ª–∏–∫–∞ üìπ', 'Video sifatida olish üìπ'])

    dispatcher.register_message_handler(send_generate_file, state=Generate.generate_file)
    dispatcher.register_message_handler(send_generate_photo, state=Generate.generate_photo)
    dispatcher.register_message_handler(send_generate_video, state=Generate.generate_video)
